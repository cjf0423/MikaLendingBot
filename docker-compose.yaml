# start: docker-compose up -d
# stop: docker-compose down
# logs: docker-compose logs
# state: docker-compose ps

# This docker-compose file starts 3 docker containers. One for nginx and one for a bot on each exchange. 
# You can start as many bots as you want using the same config style and they will all have their web
# interface accessible via the name you set of VIRTUAL_HOST

# VIRTUAL_HOST can be changed to poloniex.yourdomain.com if you want it to be accessible via the internet

# The environment variables included are the minimum required to get it working, you can change a lot of bot
# configurations with them using the same naming convention, i.e. CATEGORY_OPTION. 

# Environment variables take precedence over the config file

# If you have a more complicated setup, you can create a new config file from default.cfg and then use that in
# the command line for each container.

# If you want to use this on your local machine, without a domain name, you can add lines like this to /etc/hosts
# 127.0.0.1 poloniex.localhost
# 127.0.0.1 bitfinex.localhost

version: '2.1'

services:
  nginx:
    image: jwilder/nginx-proxy
    container_name: nginx-proxy
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
    restart: unless-stopped

  bitfinex:
    image: amancevice/pandas:0.23.4-python2
    container_name: mika-bitfinex
    restart: always
    depends_on:
      - nginx
    working_dir: /app
    environment:
      # 只留这四行！全部其他都删掉！
      - VIRTUAL_HOST=bitfinex.541233945.xyz    # 改成你自己的域名或随便写
      - VIRTUAL_PORT=8000
      - VIRTUAL_PROTO=http
      # 注意：API 密钥完全靠 default.cfg，不写任何 API_apikey/secret 环境变量！
    expose:
      - "8000"
    ports:
      - "8000:8000"          # 加上这行，方便直连调试
    volumes:
      - .:/app               # 关键：挂载你本地完整项目（含修好的 Bitfinex.py）
    command: >
      bash -c "
        # 彻底禁用官方 setup-container.sh（防止它 git clone 覆盖你修好的代码！）
        echo 'echo \"Using local fixed code, skip git clone\"' > /app/setup-container.sh &&
        chmod +x /app/setup-container.sh &&
        
        # 修复权限 + 预创建 json（解决 EOF 问题）
        chmod -R 777 /app/www &&
        rm -f /app/www/botlog.json &&
        echo '{\"status\":\"Running\",\"data\":{}}' > /app/www/botlog.json &&
        
        # 安装依赖 + 启动（和你本地完全一样，绝不加任何非法参数）
        pip install -r /app/requirements.txt &&
        python /app/lendingbot.py -cfg /app/default.cfg
      "
