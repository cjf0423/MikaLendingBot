### 部署 MikaLendingBot 到云服务器实现 Bitfinex 自动放贷指南

你好！MikaLendingBot 是一个开源的 Python 工具，用于自动化在 Bitfinex（和 Poloniex）上放贷。它会根据你配置的策略自动将你的加密货币贷出，捕捉高利率机会。下面我基于项目的官方文档和相关教程，详细解释如何在云服务器（假设是 Linux VPS，如 Ubuntu 或 CentOS）上部署它，实现 Bitfinex 自动放贷。

**重要警告和前提：**

- **Python 版本要求**：必须使用 Python 2.7.x（项目不支持 Python 3）。Python 2 已于 2020 年停止官方支持，存在安全风险。请确保你的服务器安全（如使用防火墙、定期更新）。
- **Bitfinex API 权限**：Bot 只需读取账户历史、保证金融资（Margin Funding）和钱包信息，以及写入保证金融资权限。**不要**授予交易、提现或存款权限，以降低风险。
- **风险提醒**：自动化放贷涉及资金风险（如市场波动、交易所问题）。Bot 无法提取你的资金，但 API 密钥泄露可能导致问题。测试时用小额资金，先用“dry run”模式（模拟运行，不实际放贷）。
- **服务器要求**：Linux 系统（推荐 Ubuntu 20.04+），至少 1GB RAM，稳定网络。安装 Git、pip 和 Docker（推荐用于部署）。
- **项目仓库**：使用你提供的 https://github.com/BitBotFactory/MikaLendingBot（文档中类似项目仓库为 poloniexlendingbot，但步骤通用）。

#### 步骤 1: 准备云服务器环境

1. 登录你的云服务器（SSH 方式，例如 ssh user@your-server-ip）。

2. 更新系统包：

   text

   ```
   sudo apt update && sudo apt upgrade -y  # Ubuntu/Debian
   # 或 CentOS: sudo yum update -y
   ```

3. 安装 Python 2.7（如果未安装）：

   text

   ```
   sudo apt install python2.7 python-pip git -y  # Ubuntu
   # 或 CentOS: sudo yum install python27 python-pip git -y
   ```

   - 将 Python 2.7 添加到 PATH（如果需要）：编辑 ~/.bashrc 添加 export PATH="/usr/bin/python2.7:$PATH"，然后 source ~/.bashrc。

4. 安装 Docker 和 Docker Compose（推荐，用于简单部署和容器化，避免依赖冲突）：

   text

   ```
   sudo apt install docker.io docker-compose -y
   sudo usermod -aG docker $USER  # 添加当前用户到 docker 组
   newgrp docker  # 生效，无需重启
   ```

#### 步骤 2: 下载和安装 MikaLendingBot



1. 克隆仓库（推荐，便于后续更新）：

   text

   ```
   git clone https://github.com/cjf0423/MikaLendingBot.git .
   ```

   - 或者下载 ZIP 文件：从 GitHub 页面下载 ZIP，解压到当前目录 unzip MikaLendingBot-main.zip && mv MikaLendingBot-main/* .。

2. 安装 Python 依赖：

   text

   ```
   pip install -r requirements.txt  # 使用 Python 2.7 的 pip
   ```

   - 如果权限问题：sudo pip install -r requirements.txt（但避免 root 运行 Bot）。
   - 常见依赖：requests、pytz、numpy（可选，用于分析模块）。

#### 步骤 3: 配置 Bitfinex API 和 Bot 策略

1. 生成配置文件：

   text

   ```
   cp default.cfg.example default.cfg  # 或运行 python lendingbot.py 一次自动生成
   ```

2. 编辑 

   default.cfg

   （用 nano 或 vim：

   nano default.cfg

   ）：

   - **选择交易所**：设置 exchange = bitfinex（确保是 Bitfinex）。

   - API 密钥

     ：

     - API_apikey = 你的Bitfinex_API_Key
     - API_apisecret = 你的Bitfinex_API_Secret
     - 如何获取 Bitfinex API：
       - 登录 Bitfinex > 账户 > API > 创建新密钥。
       - 权限：只勾选 “Margin Funding: Read & Write” 和 “Wallets: Read”。**不要**选交易/提现！
       - 复制 Key 和 Secret 到配置文件。

   - 放贷策略配置

     （核心部分，根据你的偏好调整）：

     - min_daily_rate = 0.01：最低日利率阈值（例如 1%，低于此不放贷）。

     - max_daily_rate = 0.05：最高日利率（例如 5%）。

     - offer_duration = 2：放贷期限（天数，2-60 天）。

     - spread = true：启用利率分散策略（将资金分散到多个利率水平，捕捉峰值）。

     - withhold_rate = 0.1：保留 10% 资金，直到利率达到阈值。

     - 币种配置：如 coins = BTC,ETH（只放贷指定币种）。

     - 其他：启用 webserver = true 以访问网页仪表盘（默认端口 8080）。

     - 示例配置片段（简化）：

       text

       ```
       [bitfinex]
       exchange = bitfinex
       API_apikey = YOUR_API_KEY
       API_apisecret = YOUR_API_SECRET
       min_daily_rate = 0.01
       max_daily_rate = 0.05
       offer_duration = 2
       spread_offers = true
       coins = BTC,USDT
       ```

   - 保存文件。详细配置选项见项目 Wiki 或运行 python lendingbot.py -h 查看帮助。

3. 测试配置：

   - 运行干跑模式：python lendingbot.py -dry（模拟放贷，不实际操作）。
   - 检查日志：Bot 会输出到控制台或日志文件，确认连接 Bitfinex 成功，无 API 错误。

#### 步骤 4: 部署到服务器并自动化运行

推荐两种方式：**Docker（简单，隔离环境）** 或 **Systemd 服务（原生运行）**。Docker 更适合云服务器，便于管理。

**方式一：使用 Docker（推荐）**

1. 项目支持 Docker Compose。确保 docker-compose.yaml 在目录中（如果没有，从 GitHub 下载或复制示例）。

2. 编辑 

   docker-compose.yaml

   （添加 Bitfinex 配置）：

   text

   ```
   version: '2.1'
   
   services:
     nginx:
       image: jwilder/nginx-proxy
       container_name: nginx-proxy
       ports:
         - "80:80"
       volumes:
         - /var/run/docker.sock:/tmp/docker.sock:ro
       restart: unless-stopped
   
     bitfinex:
       image: amancevice/pandas:0.23.4-python2
       container_name: mika-bitfinex
       restart: always
       depends_on:
         - nginx
       working_dir: /app
       environment:
         # 只留这四行！全部其他都删掉！
         - VIRTUAL_HOST=bitfinex.541233945.xyz    # 改成你自己的域名或随便写
         - VIRTUAL_PORT=8000
         - VIRTUAL_PROTO=http
         # 注意：API 密钥完全靠 default.cfg，不写任何 API_apikey/secret 环境变量！
       expose:
         - "8000"
       ports:
         - "8000:8000"          # 加上这行，方便直连调试
       volumes:
         - .:/app               # 关键：挂载你本地完整项目（含修好的 Bitfinex.py）
       command: >
         bash -c "
           # 彻底禁用官方 setup-container.sh（防止它 git clone 覆盖你修好的代码！）
           echo 'echo \"Using local fixed code, skip git clone\"' > /app/setup-container.sh &&
           chmod +x /app/setup-container.sh &&
           
           # 修复权限 + 预创建 json（解决 EOF 问题）
           chmod -R 777 /app/www &&
           rm -f /app/www/botlog.json &&
           echo '{\"status\":\"Running\",\"data\":{}}' > /app/www/botlog.json &&
           
           # 安装依赖 + 启动（和你本地完全一样，绝不加任何非法参数）
           pip install -r /app/requirements.txt &&
           python /app/lendingbot.py -cfg /app/default.cfg
         "
   ```

   

3. 启动：

   text

   ```
   docker-compose up -d  # 后台运行
   ```

4. 检查：

   - 日志：docker-compose logs -f bitfinex-bot
   - 网页界面：浏览器访问 http://your-server-ip:8080（查看放贷状态、利润报告）。如果本地测试，编辑 /etc/hosts 添加 127.0.0.1 bitfinex.localhost。

5. 更新：git pull && docker-compose down && docker-compose up -d --build。

6. 停止/重启：docker-compose stop / docker-compose restart。

**方式二：使用 python2 服务（无 Docker）**

1. 直接用python2在后台运行：

   

   ```
   nohup python2.7 lendingbot.py -cfg default.cfg > mika.log 2>&1 &
   
   ```

2. 退出用下面命令：

   

   ```
   pkill -f lendingbot.py
   ```

3. 网页界面：同样访问 http://your-server-ip:8080。

#### 步骤 5: 监控和维护

- **网页仪表盘**：启用后，从任何地方访问，查看实时放贷活动、利率、利润（支持 USD 显示）。
- **日志**：Bot 日志保存在项目根目录，定期检查错误（如 API 失效）。
- **更新策略**：根据市场调整 default.cfg 中的利率阈值。重启 Bot 生效。
- **多账户**：用不同配置文件运行多个实例（-cfg other.cfg）。
- **定时运行**：Bot 设计为持续运行（每 30 秒检查一次），无需 cron。
- **回撤日期**：配置 recall_date 确保指定日期前收回资金。

#### 常见问题排查

- **API 错误**：确认密钥正确、权限足够。测试：用 Bitfinex API 测试工具验证。
- **Python 依赖失败**：用 virtualenv 隔离：pip install virtualenv; virtualenv -p python2.7 venv; source venv/bin/activate; pip install -r requirements.txt。
- **防火墙**：开放 8080 端口：sudo ufw allow 8080。
- **Bitfinex 特定**：Bot 会自动转移资金到融资账户，放贷 BTC/ETH 等。确保有足够资金在钱包。
- 如果卡住：加入 Gitter 聊天（https://gitter.im/Mikadily/poloniexlendingbot）或 Reddit 子版块求助。

部署后，Bot 会 24/7 自动放贷，最大化你的收益！如果遇到具体错误，贴出日志我可以帮你 debug。记得从小额测试开始。